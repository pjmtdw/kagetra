%script#templ-event-detail(type='text/template')
  .row
    .large-8.columns
      %fieldset.panel
        %legend 大会/行事名
        %span <%- data.name %>
        <% if(data.formal_name){ %>
        %span (<%- data.formal_name %>)
        <% } %>
    .large-4.columns
      %fieldset.panel
        %legend 種別
        <%= _.show_kind_detail(data) %>
  .row
    .large-7.columns
      %fieldset.panel
        %legend 場所
        <%- data.place %>
    .large-3.columns
      %fieldset.panel
        %legend 日時
        %div
          <% tilde = (data.start_at || data.end_at)?"&sim;":"" %>
          <%= data.date %> <%= data.start_at %> <%= tilde %> <%= data.end_at %>
    .large-2.columns
      %fieldset.panel
        %legend 締切日
        %div <%= data.deadline %>
  .row
    .large-12.columns
      %fieldset.panel
        %legend 備考
        .pre <%- data.description %>
  .row
    .large-12.columns
      .participants

%script#templ-event-participant(type='text/template')
  -# data.participant[-1] が存在するならそれは選択肢が表示不可のもの
  <% templ_i = _.template($("#templ-participant-item").html()) %>
  <% templ_a = _.template_braces($("#templ-participant-attr").html()) %>
  <% choices = (data.participant && data.participant[-1])?[{name:"登録者",positive:true,id:-1}]:data.choices %>
  <% _.each(_.filter(choices,function(c){return c.positive || data.show_all}),function(c){ %>
  <% p = data.participant && data.participant[c.id] || [] %>
  %fieldset.panel.participant-choice(data-choice-id='{{c.id}}')
    %legend {- c.name -} ({{ _.flatten(_.map(p,function(x){return x[1]})).length }})
    <% _.each(p,function(q){ %>
    {{ templ_a({data:data,templ:templ_i,q:q}) }}
    <% }) %>
  <% }) %>

%script#templ-participant-item(type='text/template')
  .item
    %span.name <%= name %>

%script#templ-participant-attr(type='text/template')
  %div.event-participants(data-attr-value='{{q[0]}}')
    .label.round.attr {- _.object(data.participant_attrs)[q[0]] -}
    <% _.each(q[1],function(x){ %>
    {{templ({name:data.participant_names[x]})}}
    <% }) %>

= haml :comment

%script
  -# Rubyの連想配列は順番が保持されるけどJavaScriptは保持されないので配列に変換
  var g_event_kinds_str='#{G_EVENT_KINDS.to_a.to_json}' 
  var g_team_sizes_str='#{G_TEAM_SIZES.to_a.to_json}'
